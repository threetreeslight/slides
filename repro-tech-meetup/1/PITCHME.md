## `systemd-nspawn` <br> „ÅØ‰æøÂà©„Çâ„Åó„ÅÑ

@threetreeslight

on Repro Tech Meetup #1

---

## whoami

![](https://avatars3.githubusercontent.com/u/1057490?s=200&v=4)

@threetreeslight / VPoE at Repro

shinjuku.rb, shinjuku-aar, shinjuku-mokumoku, Hacking HR! „Å™„Å©„ÅÆ„Ç≥„Éü„É•„Éã„ÉÜ„Ç£„Ç™„Éº„Ç¨„Éä„Ç§„Ç∂„Éº„Åó„Å¶„ÅÑ„Åæ„Åô


---

## „Å®„ÅÇ„Çã„ÇÇ„Åè„ÇÇ„Åè‰ºö„Å´„Å¶„Éª„Éª„Éª

„Äå `systemd-nspawn` „Åå‰æøÂà©„Åô„Åé„Å¶docker„ÅÆcommand Âøò„Çå„ÅüË©±„ÇíËÅû„ÅÑ„Åü„ÅÆ„Åß‰Ωø„Å£„Å¶„Åø„Åü üòá „Äç„Å®„ÅÑ„ÅÜË©±„ÇíËÅû„Åè 

---

# „Åù„Çì„Å™„ÇÇ„ÅÆ„Åå‰∏ñ„ÅÆ‰∏≠„Å´„ÅÇ„Çã„Å™„Çì„Å¶!!!

---

## `systemd-nspawn` „Å£„Å¶‰ΩïÔºü

> systemd-nspawn is like the chroot command, but it is **a chroot on @color[red](steroids)**.
>
> -- [archlinux wiki - systemd-nspawn](https://wiki.archlinux.org/index.php/Systemd-nspawn)

---?image=repro-tech-meetup/1/meme-yatta.png?size=auto 100%

# @color[red](Âº∑„Åè„Å¶„É§„Éê„Ç§ `chroot`)

---

# ÂÖ®„Åè„Çè„Åã„Çâ„Çì

![](repro-tech-meetup/1/meme-oh.png)

---

## „ÇÇ„ÅÜ„Åô„Åì„ÅóË™≠„ÅøËß£„Åè„Å®

systemd-nspawn„ÅØËªΩÈáè„Å™ÂêçÂâçÁ©∫Èñì„Ç≥„É≥„ÉÜ„ÉäÊäÄË°ì„ÄÇÂÖ∑‰ΩìÁöÑ„Å´„ÅØ‰ª•‰∏ã„Çí‰ªÆÊÉ≥Âåñ„Åô„Çã

- „Éï„Ç°„Ç§„É´„Ç∑„Çπ„ÉÜ„É†ÈöéÂ±§
- „Éó„É≠„Çª„Çπ„ÉÑ„É™„Éº
- „Åï„Åæ„Åñ„Åæ„Å™IPC„Çµ„Éñ„Ç∑„Çπ„ÉÜ„É†
- „Éõ„Çπ„Éà„Å®„Éâ„É°„Ç§„É≥Âêç

---

# „Å™„Çã„Åª„Å©Ôºü

---

# ‰ª•‰∏ã„ÄÅÈñìÈÅï„Å£„Å¶„Åü„Çâ„Åî„ÇÅ„Çì„Å™„Åï„ÅÑ üôá

---

## Docker„ÅÆÊßãÊàêÊäÄË°ì

1. namespaces <- ü§î
1. Control groups <- ü§î
1. Union file systems
1. Container format

From [dockr overview - the-underlying-technology](https://docs.docker.com/engine/docker-overview/#the-underlying-technology)

---

## `linux namespace`

ÈöéÂ±§ÊßãÈÄ†„Å´ÂêçÂâçÁ©∫Èñì„ÇíÂàá„ÇäÂàÜ„Åë„ÄÅ„Åù„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÇíÂà∂Èôê„Åô„Çã„ÇÑ„Å§„ÄÇ

containerÂÜÖ„ÅÆPID„Åå1„Åã„ÇâÂßã„Åæ„Çã„ÅÆ„ÅØ„Åì„ÅÆÂ≠ê„ÅÆ„Åä„Åã„Åí„ÄÇ

-- [wiki - Linux namespaces](https://en.wikipedia.org/wiki/Linux_namespaces)

---

## `Control groups(cgroup)`

process„Çígrouping„Åó„ÄÅCPU, memory, disk I/O, network, etc.„ÅÆresouce„ÅÆÂà©Áî®„ÇíÁõ£Ë¶ñ„ÄÅÂà∂Èôê„Åô„Çã„ÇÑ„Å§„ÄÇ

„Åì„ÅÆ„Åä„Åã„Åí„ÅßÁâπÂÆö„Éó„É≠„Çª„Çπ„Ååhost„ÅÆ„É™„ÇΩ„Éº„Çπ„ÇíÂ∞ÇÊúâ„Åó„Å¶„Åó„Åæ„ÅÜ‰∫ãË±°„ÇíÈò≤„Åê„ÄÇ

-- [wiki - cgroups](https://en.wikipedia.org/wiki/Cgroups)

---

## „Åß„ÄÅ`chroot` „ÅØÔºü

„É´„Éº„Éà„Éá„Ç£„É¨„ÇØ„Éà„É™„ÇíÂ§âÊõ¥„Åó„Å¶„ÄÅ„Åù„ÅÆÂ§ñ„ÅÆ„Éï„Ç°„Ç§„É´„ÇÑ„Ç≥„Éû„É≥„Éâ„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÇíÂà∂Èôê„Åô„Çã„ÇÑ„Å§„ÄÇ

```sh
docker run --rm -it debian:latest sh
apt-get update
apt-get install -y binutils debootstrap
mkdir -p /srv/chroot/wheezy
debootstrap --arch i386 wheezy /srv/chroot/wheezy http://httpredir.debian.org/debian

chroot /srv/chroot/wheezy /bin/bash
I have no name!@1af6c5c55369:/$
# „ÅÑ„ÇÑ„Å£„Åµ„ÅÖ
```

https://wiki.debian.org/chroot

---

## `systemd-nspawn` „ÅÆÈõ∞Âõ≤Ê∞ó

linux namespace + chroot = <br> 
@color[orange](**a chroot on steroids**)

---

## „ÇÑ„Å£„Å¶„Åø„Çã<br>`debian/jessie64`

```sh
# create a new container using debootstrap
$ CDIR=/var/lib/machines/freedombox
$ sudo debootstrap sid $CDIR
$ sudo systemd-nspawn -D $CDIR --machine FreedomBox

root@FreedomBox:~$ apt-get install -y freedombox-setup

# set root password and stop the container
root@FreedomBox:~$ passwd root
root@FreedomBox:~$ ^D
```

---

## „ÅÑ„Åè„ÅúÔºÅ

```sh
# start the container and its services
$ sudo systemd-nspawn -D $CDIR --machine FreedomBox -b
Spawning container FreedomBox on /var/lib/machines/freedombox.
Press ^] three times within 1s to kill container.
/etc/localtime is not a symlink, not updating container timezone.
systemd 239 running in system mode. (+PAM +AUDIT +SELINUX +IMA +APPARMOR +SMACK +SYSVINIT +UTMP +LIBCRYPTSETUP +GCRYPT +GNUTLS +ACL +XZ +LZ4 +SECCOMP +BLKID +ELFUTILS +KMOD -IDN2 +IDN -PCRE2 default-hierarchy=hybrid)
Detected virtualization systemd-nspawn.
Detected architecture x86-64.

Welcome to Debian GNU/Linux buster/sid!

Set hostname to <jessie>.
File /lib/systemd/system/systemd-journald.service:36 configures an IP firewall (IPAddressDeny=any), but the local system does not support BPF/cgroup based firewalling.
Proceeding WITHOUT firewalling in effect! (This warning is only shown for the first loaded unit using IP firewalling.)
[  OK  ] Reached target Swap.
[  OK  ] Reached target System Time Synchronized.
[  OK  ] Listening on Syslog Socket.
[  OK  ] Started Dispatch Password Requests to Console Directory Watch.
[  OK  ] Listening on Journal Socket.
system.slice: Failed to reset devices.list: Operation not permitted
dev-hugepages.mount: Failed to reset devices.list: Operation not permitted
         Mounting Huge Pages File System...
systemd-remount-fs.service: Failed to reset devices.list: Operation not permitted
         Starting Remount Root and Kernel File Systems...
[  OK  ] Reached target Remote File Systems.
dev-mqueue.mount: Failed to reset devices.list: Operation not permitted
         Mounting POSIX Message Queue File System...
[  OK  ] Started Forward Password Requests to Wall Directory Watch.
[  OK  ] Reached target Paths.
system-getty.slice: Failed to reset devices.list: Operation not permitted
[  OK  ] Created slice system-getty.slice.
[  OK  ] Created slice User and Session Slice.
resolvconf.service: Failed to reset devices.list: Operation not permitted
         Starting Nameserver information manager...
[  OK  ] Reached target Slices.
[  OK  ] Reached target Local Encrypted Volumes.
[  OK  ] Listening on initctl Compatibility Named Pipe.
ifupdown-pre.service: Failed to reset devices.list: Operation not permitted
         Starting Helper to synchronize boot up for ifupdown...
[  OK  ] Listening on Journal Socket (/dev/log).
systemd-journald.service: Failed to reset devices.list: Operation not permitted
         Starting Journal Service...
[  OK  ] Mounted Huge Pages File System.
[  OK  ] Mounted POSIX Message Queue File System.
[  OK  ] Started Remount Root and Kernel File Systems.
systemd-sysusers.service: Failed to reset devices.list: Operation not permitted
         Starting Create System Users...
[  OK  ] Started Helper to synchronize boot up for ifupdown.
[  OK  ] Started Nameserver information manager.
[  OK  ] Started Create System Users.
[  OK  ] Reached target Local File Systems (Pre).
[  OK  ] Reached target Local File Systems.
[  OK  ] Started Journal Service.
         Starting Flush Journal to Persistent Storage...
[  OK  ] Started Flush Journal to Persistent Storage.
         Starting Create Volatile Files and Directories...
[  OK  ] Started Create Volatile Files and Directories.
         Starting Update UTMP about System Boot/Shutdown...
[  OK  ] Started Update UTMP about System Boot/Shutdown.
[  OK  ] Reached target System Initialization.
[  OK  ] Started Daily apt download activities.
[  OK  ] Listening on D-Bus System Message Bus Socket.
[  OK  ] Started Daily apt upgrade and clean activities.
[  OK  ] Started Daily Cleanup of Temporary Directories.
[  OK  ] Listening on Avahi mDNS/DNS-SD Stack Activation Socket.
[  OK  ] Reached target Sockets.
[  OK  ] Reached target Basic System.
         Starting Modem Manager...
[  OK  ] Started D-Bus System Message Bus.
         Starting firewalld - dynamic firewall daemon...
         Starting WPA supplicant...
[  OK  ] Started handle automounting.
         Starting Restore /etc/resolv.conf if the system crashed before the ppp link was shut down...
         Starting System Logging Service...
         Starting Avahi mDNS/DNS-SD Stack...
[  OK  ] Started Run certbot twice daily.
         Starting Name Service Cache Daemon...
[  OK  ] Started Clean PHP session files every 30 mins.
[  OK  ] Reached target Timers.
         Starting Login Service...
[  OK  ] Started Restore /etc/resolv.conf if the system crashed before the ppp link was shut down.
[  OK  ] Started Name Service Cache Daemon.
[  OK  ] Started Login Service.
[  OK  ] Started System Logging Service.
[  OK  ] Started Avahi mDNS/DNS-SD Stack.
[  OK  ] Started WPA supplicant.
         Starting Authorization Manager...
[  OK  ] Started Authorization Manager.
[  OK  ] Started Modem Manager.
[  OK  ] Started firewalld - dynamic firewall daemon.
[  OK  ] Reached target Network (Pre).
         Starting Raise network interfaces...
         Starting Network Manager...
[  OK  ] Started Raise network interfaces.
[  OK  ] Started Network Manager.
         Starting Network Manager Wait Online...
[  OK  ] Reached target Network.
         Starting Fail2Ban Service...
         Starting OpenBSD Secure Shell server...
         Starting Network Time Service...
         Starting Permit User Sessions...
[  OK  ] Started Plinth Web Interface.
[  OK  ] Started Unattended Upgrades Shutdown.
[  OK  ] Started Fail2Ban Service.
[FAILED] Failed to start OpenBSD Secure Shell server.
See 'systemctl status ssh.service' for details.
[  OK  ] Started Permit User Sessions.
[  OK  ] Started Console Getty.
[  OK  ] Reached target Login Prompts.
         Starting Hostname Service...
[  OK  ] Started Network Time Service.
[  OK  ] Started Hostname Service.
         Starting Network Manager Script Dispatcher Service...
[  OK  ] Started Network Manager Script Dispatcher Service.
[  OK  ] Started Network Manager Wait Online.
[  OK  ] Reached target Network is Online.
         Starting LSB: OpenLDAP standalone server (Lightweight Directory Access Protocol)...
[  OK  ] Started LSB: OpenLDAP standalone server (Lightweight Directory Access Protocol).
         Starting LSB: LDAP connection daemon...
[  OK  ] Started LSB: LDAP connection daemon.
         Starting The Apache HTTP Server...
[  OK  ] Started Regular background program processing daemon.
[  OK  ] Started The Apache HTTP Server.
[  OK  ] Reached target Multi-User System.
[  OK  ] Reached target Graphical Interface.
         Starting Update UTMP about System Runlevel Changes...
[  OK  ] Started Update UTMP about System Runlevel Changes.

Debian GNU/Linux buster/sid jessie console

jessie login: root
Password:
Linux jessie 3.16.0-6-amd64 #1 SMP Debian 3.16.56-1+deb8u1 (2018-05-08) x86_64

                         .--._    _.--.
                        (     \  /     )
                         \     /\     /
                          \_   \/   _/
                           /        \
                          (    /\    )
                           `--'  `--'

                           FreedomBox

FreedomBox is a pure blend of Debian GNU/Linux.  FreedomBox manual is
available in /usr/share/doc/plinth.

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
root@jessie:~#
root@jessie:~#
```

---

## „ÇÑ„Å£„Åü„Å≠ÔºÅ

ÊôÆÈÄö„ÅÆdocker image„Çítar„ÅßÂõ∫„ÇÅ„Åü„ÅÆ„Çínspawn„ÅßÁ´ã„Å°‰∏ä„Åí„Å¶„ÇÇÂãï„ÅèÔºà„Çâ„Åó„ÅÑ)

---

## ‰Ωï„ÅåÂ¨â„Åó„ÅÑ„ÅãÔºü(Êçª„ÇäÂá∫„Åô)

- docker„Å´Èñ¢„Çè„Çãecosystem„Åå‰∏çË¶Å„Å™„ÅÆ„Åß„ÄÅÁ¥îÁ≤ã„Å´ÈöîÈõ¢Áí∞Â¢É„Å§„Åè„Çã„Å®„Åç„ÅØ„ÅÇ„Çä„Åù„ÅÜÔºü
- Docker„ÅÆ„Çà„ÅÜ„Å´Layer„ÅßÁÆ°ÁêÜ„Åó„Å™„ÅÑ„ÅÆ„Åßimage„ÅåËªΩ„ÅÑ„ÄÇ
- systemd„Å®ÁµÑ„ÅøÂêà„Çè„Åõ„Å¶Ëµ∑ÂãïÊôÇ„Å´„ÅÑ„ÅÑÊÑü„Åò„Å´Á´ã„Å¶„Å®„Åè„Å®„Åã„ÇÇ„Åß„Åç„ÇãÔºà„Å®ÊÄù„ÅÜÔºâ
- „Åü„Å†„ÅÆfile„Å™„ÅÆ„Åß„ÄÅÊ∞óÂêàÂÖ•„Çå„Çå„Å∞gitÁÆ°ÁêÜ„Åß„Åç„Çã(gitignore„ÅØ„ÅÑ„Å£„Å±„ÅÑÊõ∏„Åè)

---

## „Å†„Åå `systemd`„ÅåÂãï„Åè„Å®„Åì„Çç„Åó„ÅãÂãï„Åã„Å™„ÅÑ

„Å°„Çá„Å£„Å®Áí∞Â¢ÉÊ±ö„Åï„ÅöÂãï„Åã„Åô„ÅÆ„Å™„Çâ„ÄÅ<br>chroot„Å®debootstrap„ÅßËâØ„ÅÑÊ∞ó„ÇÇ„Åô„Çã ü§î

---

## „Ç≥„É≥„ÉÜ„ÉäÊäÄË°ì‰æøÂà© ‚ù§Ô∏è

---

# references

- [chroot, cgroups and namespaces‚Ää‚Äî‚ÄäAn overview](https://itnext.io/chroot-cgroups-and-namespaces-an-overview-37124d995e3d)
- [archlinux wiki - systemd-nspawn](https://wiki.archlinux.org/index.php/Systemd-nspawn)
- [debian - nspawn](https://wiki.debian.org/nspawn)
- [wiki - Linux namespaces](https://en.wikipedia.org/wiki/Linux_namespaces)
- [wiki - cgroups](https://en.wikipedia.org/wiki/Cgroups)
